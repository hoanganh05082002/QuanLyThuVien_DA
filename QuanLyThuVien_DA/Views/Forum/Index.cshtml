﻿@model IEnumerable<QuanLyThuVien_DA.Models.FITHOU_LIB_PostView>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
}

@{
    // Lấy thông tin từ Session
    var userID = Session["UserID"];
    var userName = Session["UserName"];
    var userRole = Session["UserRole"];
}

<script src="~/Plugins/Plugins/ckeditor/ckeditor.js"></script>

@if (userID != null)
{
    <div style="position: fixed; top: 10px; right: 10px;">
        <a class="nav-link edit-btn text-dark" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="mr-2 d-none d-lg-inline text-gray-600 small font-weight-bold">Xin chào, @userName</span>
        </a>

        <!-- Dropdown - User Information -->
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item edit-btn" href="~/Home/UserProfile">
                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                Trang cá nhân
            </a>
            @if (!userRole.Equals("Sinh viên") && !userRole.Equals("Giảng viên"))
            {
                <a class="dropdown-item" href="~/Admin/Default">
                    <i class="fas fa-toolbox fa-sm fa-fw mr-2 text-gray-400 mt-2"></i>
                    Trang quản trị
                </a>
            }
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="~/Home/Logout">
                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                Đăng xuất
            </a>
        </div>
    </div>
}
else
{
    <div style="position: fixed; top: 10px; right: 10px;">
        <a class="nav-link" href="@Url.Action("Login", "Home")">
            <span class="mr-2 d-none d-lg-inline text-gray-600 small text-dark font-weight-bold">Đăng nhập</span>
        </a>
    </div>
}

<!-- Modal Thêm, Sửa -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true"
     data-user-id="@userID" data-user-name="@userName" data-user-role="@userRole" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createModalLabel">Thêm bài đăng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm" class="needs-validation" novalidate>
                    <input type="hidden" id="PostId" name="PostId">
                    <input type="hidden" id="UserID" name="UserID" value="@userID">

                    <!-- Tiêu đề -->
                    <div class="mb-3 row">
                        <label for="TieuDe" class="col-sm-3 col-form-label text-end">Tiêu đề</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="TieuDe" name="TieuDe" placeholder="Nhập tiêu đề" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập tiêu đề.
                            </div>
                        </div>
                    </div>

                    <!-- Nội dung -->
                    <div class="mb-3 row">
                        <label for="NoiDung" class="col-sm-3 col-form-label text-end">Nội dung</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="NoiDung" name="NoiDung" rows="4" placeholder="Nhập nội dung"></textarea>
                        </div>
                    </div>

                    <!-- Người thêm -->
                    <div class="mb-3 row">
                        <label for="HoTen" class="col-sm-3 col-form-label text-end">Người thêm</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control bg-light" id="HoTen" name="HoTen" readonly required>
                            <div class="invalid-feedback">

                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<link href="~/Interface/vendor/fontawesome-pro-6.0.0-beta3-web/fontawesome-pro-6.0.0-beta3-web/css/all.min.css" rel="stylesheet" />

<h2 class="text-center font-weight-bold mb-4 text-primary">Danh sách bài đăng</h2>

<!-- Button to open Create Modal -->
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <form class="form-inline">
                <input type="text" id="searchTerm" name="searchTerm" class="form-control mr-sm-2" placeholder="Tìm kiếm bài đăng">
                <button type="button" class="btn btn-primary mr-3" onclick="searchPosts()">Tìm kiếm</button>
                @if (userID != null)
                {
                    <button type="button" class="btn btn-primary mr-3" data-bs-toggle="modal" data-bs-target="#createModal" id="openCreateModalBtn">
                        <span class="text-white"> Thêm </span>
                    </button>
                }
                <button type="button" class="btn btn-warning" onclick="resetSearch()">
                    <i class="fa fa-arrow-rotate-right"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="postsList">
        @foreach (var post in Model)
        {
            <div class="post-box news-item mb-3">
                <div class="card shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-2" data-toggle="tooltip" title="@post.TieuDe">
                                <i class="fas fa-newspaper mr-2"></i>
                                <a href="@Url.Action("Details", "Forum", new { id = post.ID })" class="text-black">@post.TieuDe</a>
                            </h5>
                            @if (userName != null && userName.Equals(post.HoTen))
                            {
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa fa-ellipsis-h"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                        <a class="dropdown-item editPostBtn" href="#" data-id="@post.ID">
                                            <i class="fa fa-edit mr-2"></i> Sửa
                                        </a>
                                        <a class="dropdown-item deletePostBtn" href="#" data-id="@post.ID">
                                            <i class="fa fa-trash mr-2"></i> Xóa
                                        </a>
                                    </div>
                                </div>
                            }
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted">
                            <i class="far fa-clock mr-2"></i> Ngày đăng: @post.NgayTao.ToString("dd/MM/yyyy")
                        </h6>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="d-flex justify-content-center" id="pagination">
        @if (ViewBag.Pagination != null)
        {
            <div class="d-flex justify-content-center">
                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        @if (ViewBag.Pagination.PageNumber > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="searchPosts(@(ViewBag.Pagination.PageNumber - 1))" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        }

                        @for (int i = 1; i <= ViewBag.Pagination.PageTotal; i++)
                        {
                            <li class="page-item @(i == ViewBag.Pagination.PageNumber ? "active" : "")">
                                <a class="page-link" href="#" onclick="searchPosts(@i)">@i</a>
                            </li>
                        }
                        @if (ViewBag.Pagination.PageNumber < ViewBag.Pagination.PageTotal)
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="searchPosts(@(ViewBag.Pagination.PageNumber + 1))" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>

</div>

@* Modal Toast *@
<div aria-live="polite" aria-atomic="true" style="position: relative; z-index: 9999;">
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px;">
        <div class="toast" id="actionToast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="1000">
            <div class="toast-header">
                <strong class="mr-auto" id="toastTitle">Thông báo</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body text-white" id="toastMessage"></div>
        </div>
    </div>
</div>

<!-- Modal xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa bài đăng này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
      $(document).ready(function () {
    CKEDITOR.replace('NoiDung');

    // Xử lý sự kiện khi nhấn nút Thêm
    $('#openCreateModalBtn').click(function () {
        $('#createModalLabel').text('Thêm bài đăng');
        $('#saveChangesBtn').text('Lưu').off('click').on('click', function () {
            createPost();
        });
        $('#createForm')[0].reset();
         $('#HoTen').val(@Html.Raw(Json.Encode(userName)));

        $('#createModal').modal('show');
    });

    // Sự kiện click vào nút Edit
    $('.editPostBtn').click(function () {
        var postId = $(this).data('id');
        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetPost", "Forum")',
            data: { id: postId },
            success: function (response) {
                $('#createModalLabel').text('Sửa bài đăng');
                $('#saveChangesBtn').text('Cập nhật').off('click').on('click', function () {
                    editPost(postId);
                });

                $('#PostId').val(response.ID);
                $('#TieuDe').val(response.TieuDe);
                CKEDITOR.instances.NoiDung.setData(response.NoiDung);
                $('#HoTen').val(response.HoTen);
                $('#createModal').modal('show');
            },
            error: function () {
                showToast('Lỗi khi nạp dữ liệu bài đăng!', 'danger');
            }
        });
    });

    // Xử lý sự kiện khi đóng modal Thêm/Sửa
    $('#createModal').on('hide.bs.modal', function () {
        resetModal();
    });

    // Hàm reset modal về trạng thái mặc định
    function resetModal() {
        $('#createModalLabel').text('Thêm bài đăng');
        $('#saveChangesBtn').text('Lưu').off('click').on('click', function () {
            createPost();
        });
        $('#createForm')[0].reset();
        $('#PostId').val('');
        $('#createForm').removeClass('was-validated');

        // Reset CKEditor
        for (instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].setData('');
        }
    }


    // Hàm tạo mới bài đăng
    function createPost() {
        var form = $('#createForm')[0];
        if (form.checkValidity() === false) {
            form.classList.add('was-validated');
            return;
        }

        // Cập nhật nội dung CKEditor vào textarea
        for (instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].updateElement();
        }

        var formData = new FormData(form);
        $.ajax({
            type: 'POST',
            url: '@Url.Action("Create", "Forum")',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                if (response.success) {
                    $('#createModal').modal('hide');
                    showToast('Thêm bài đăng thành công!', 'success');
                    // Đặt thời gian trễ trước khi ẩn toast
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('Lỗi!', 'danger');
                }
            },
            error: function () {
                showToast('Lỗi!', 'danger');
            }
        });
    }

    // Hàm chỉnh sửa bài đăng
    function editPost(postId) {
        var form = $('#createForm')[0];
        if (form.checkValidity() === false) {
            form.classList.add('was-validated');
            return;
        }

        // Cập nhật nội dung CKEditor vào textarea
        for (instance in CKEDITOR.instances) {
            CKEDITOR.instances[instance].updateElement();
        }

        var formData = new FormData(form);
        formData.append("ID", postId);

        $.ajax({
            type: 'POST',
            url: '@Url.Action("Edit", "Forum")',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                if (response.success) {
                    $('#createModal').modal('hide');
                    showToast('Vui lòng chờ phê duyệt.', 'success');
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('Lỗi!', 'danger');
                }
            },
            error: function () {
                showToast('Lỗi!', 'danger');
            }
        });
          }

          // Sự kiện khi nhấn nút Xóa trong dropdown menu
          $('.deletePostBtn').click(function (e) {
              e.preventDefault();
              var postId = $(this).data('id');
              $('#deleteModal').modal('show');
              $('#confirmDeleteBtn').off('click').on('click', function () {
                  deletePost(postId);
              });
          });

          function deletePost(postId) {
            $.ajax({
                url: '@Url.Action("DeletePost", "Forum")/' + postId,
                type: 'POST',
                success: function (response) {
                    showToast('Bài đăng đã được xóa thành công.', 'success');
                    $('#deleteModal').modal('hide');
                    $('#post-' + postId).remove(); // Remove the deleted post from the list
                    // Đặt thời gian trễ trước khi ẩn toast
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                },
                error: function (xhr, status, error) {
                    showToast('Lỗi', 'Không thể xóa bài đăng.', 'danger');
                }
            });
        }

            // Hàm hiển thị thông báo Toast
            function showToast(message, type) {
                $('#toastTitle').text(type === 'success' ? 'Thành công' : 'Lỗi');
                $('#toastMessage').text(message);
                var toastElement = $('#actionToast');
                toastElement.removeClass('bg-success bg-danger').addClass('bg-' + type);
                toastElement.toast('show');
            }
      });

      function searchPosts(pageNumber = 1) {
            var searchTerm = $('#searchTerm').val();
            $.ajax({
                url: '@Url.Action("Index", "Forum")',
                type: 'GET',
                data: {
                    page: pageNumber,
                    searchTerm: searchTerm
                },
                success: function (response) {
                    var postsList = $('#postsList');
                    postsList.empty();

                    if (response.length > 0) {
                        $.each(response, function (index, post) {
                            var formattedDate = formatDateFromEpoch(post.NgayTao);
                            var postHtml = '<div class="post-box news-item">' +
                                '<div class="card mb-3">' +
                                '<div class="card-body">' +
                                '<h5 class="card-title" data-toggle="tooltip" title="' + post.TieuDe + '">' +
                                '<i class="fas fa-newspaper mr-2"></i>' +
                                '<a href="@Url.Action("Details", "Forum")/' + post.ID + '" class="text-black">' + post.TieuDe + '</a>' +
                                '</h5>' +
                                '<h6><i class="far fa-clock mr-2"></i> Ngày đăng: ' + formattedDate + '</h6>' +
                                '</div>' +
                                '</div>' +
                                '</div>'
                            postsList.append(postHtml);
                        });
                    } else {
                        postsList.append('<div class="col-md-12"><p class="text-center">Không tìm thấy bài đăng phù hợp.</p></div>');
                    }

                    // Update pagination if available
                    if (response.paginationHtml) {
                        $('#pagination').html(response.paginationHtml);
                    }
                },
                error: function () {
                    showToast('Lỗi khi tìm kiếm bài đăng!', 'danger');
                }
            });
                }
                // Hàm chuyển đổi ngày từ Epoch sang định dạng ngày tháng năm
                function formatDateFromEpoch(epochTime) {
                    var date = new Date(parseInt(epochTime.substr(6))); // Cắt bỏ '/Date(' và ')' và chuyển đổi sang số nguyên
                    var formattedDate = ('0' + date.getDate()).slice(-2) + '/'
                        + ('0' + (date.getMonth() + 1)).slice(-2) + '/'
                        + date.getFullYear();
                    return formattedDate;
        }

        function resetSearch() {
            $('#searchTerm').val('');
            searchPosts();
        }

    </script>
}



<style>
    .post-box {
        margin-bottom: 20px; /* Khoảng cách giữa các box */
    }

    .card {
        border: 1px solid #ddd; /* Viền */
        border-radius: 5px; /* Bo góc */
        padding: 15px; /* Khoảng cách nội dung và viền */
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); /* Đổ bóng */
    }

    .card-title {
        font-weight: bold;
    }

    .card-body h6 {
        color: #888; /* Màu chữ */
    }
    /* Custom CSS for the dropdown button and menu */
    .dropdown .btn-primary.dropdown-toggle {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
        padding-right: 1rem; /* Adjust padding to center text/icon */
    }

        .dropdown .btn-primary.dropdown-toggle::after {
            display: none; /* Hide the default caret */
        }

        .dropdown .btn-primary.dropdown-toggle:hover,
        .dropdown .btn-primary.dropdown-toggle:focus {
            background-color: #0056b3;
            border-color: #0056b3;
        }

    .dropdown-menu {
        border-radius: 0.25rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 1.5rem;
        color: #212529;
    }

        .dropdown-item:hover,
        .dropdown-item:focus {
            background-color: #f8f9fa;
            color: #212529;
        }

        .dropdown-item i {
            margin-right: 0.5rem;
        }
</style> 